<!DOCTYPE html>
    <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Using Lambda with self-managed Apache Kafka - AWS Lambda</title><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="assets_root" content="/assets" /><meta name="target_state" content="with-kafka" /><meta name="default_state" content="with-kafka" /><link rel="icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="shortcut icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="canonical" href="https://docs.aws.amazon.com/lambda/latest/dg/with-kafka.html" /><meta name="description" content="Learn how to use a self-managed Apache Kafka cluster as an event source for Lambda." /><meta name="deployment_region" content="IAD" /><meta name="product" content="AWS Lambda" /><meta name="guide" content="Developer Guide" /><meta name="abstract" content="" /><meta name="guide-locale" content="en_us" /><meta name="tocs" content="toc-contents.json" /><link rel="canonical" href="https://docs.aws.amazon.com/lambda/latest/dg/with-kafka.html" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/lambda/latest/dg/with-kafka.html" hreflang="id-id" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/lambda/latest/dg/with-kafka.html" hreflang="id" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/lambda/latest/dg/with-kafka.html" hreflang="de-de" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/lambda/latest/dg/with-kafka.html" hreflang="de" /><link rel="alternative" href="https://docs.aws.amazon.com/lambda/latest/dg/with-kafka.html" hreflang="en-us" /><link rel="alternative" href="https://docs.aws.amazon.com/lambda/latest/dg/with-kafka.html" hreflang="en" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/lambda/latest/dg/with-kafka.html" hreflang="es-es" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/lambda/latest/dg/with-kafka.html" hreflang="es" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/lambda/latest/dg/with-kafka.html" hreflang="fr-fr" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/lambda/latest/dg/with-kafka.html" hreflang="fr" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/lambda/latest/dg/with-kafka.html" hreflang="it-it" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/lambda/latest/dg/with-kafka.html" hreflang="it" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/lambda/latest/dg/with-kafka.html" hreflang="ja-jp" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/lambda/latest/dg/with-kafka.html" hreflang="ja" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/lambda/latest/dg/with-kafka.html" hreflang="ko-kr" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/lambda/latest/dg/with-kafka.html" hreflang="ko" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/lambda/latest/dg/with-kafka.html" hreflang="pt-br" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/lambda/latest/dg/with-kafka.html" hreflang="pt" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_cn/lambda/latest/dg/with-kafka.html" hreflang="zh-cn" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_tw/lambda/latest/dg/with-kafka.html" hreflang="zh-tw" /><link rel="alternative" href="https://docs.aws.amazon.com/lambda/latest/dg/with-kafka.html" hreflang="x-default" /><meta name="feedback-item" content="Lambda" /><meta name="this_doc_product" content="AWS Lambda" /><meta name="this_doc_guide" content="Developer Guide" /><script defer="" src="/assets/r/vendor4.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor3.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor1.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-common.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-doc-page.js?version=2021.12.02"></script><link href="/assets/r/vendor4.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-common.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-doc-page.css?version=2021.12.02" rel="stylesheet" /><script async="" id="awsc-panorama-bundle" type="text/javascript" src="https://prod.pa.cdn.uis.awsstatic.com/panorama-nav-init.js" data-config="{'appEntity':'aws-documentation','region':'us-east-1','service':'lambda'}"></script><meta id="panorama-serviceSubSection" value="Developer Guide" /><meta id="panorama-serviceConsolePage" value="Using Lambda with self-managed Apache Kafka" /></head><body class="awsdocs awsui"><div class="awsdocs-container"><awsdocs-header></awsdocs-header><awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)"><div id="guide-toc" dom-region="navigation"><awsdocs-toc></awsdocs-toc></div><div id="main-column" dom-region="content" tabindex="-1"><awsdocs-view class="awsdocs-view"><div id="awsdocs-content"><head><title>Using Lambda with self-managed Apache Kafka - AWS Lambda</title><meta name="pdf" content="/pdfs/lambda/latest/dg/lambda-dg.pdf#with-kafka" /><meta name="rss" content="lambda-updates.rss" /><meta name="forums" content="http://forums.aws.amazon.com/forum.jspa?forumID=186" /><meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=Lambda&amp;topic_url=http://docs.aws.amazon.com/en_us/lambda/latest/dg/with-kafka.html" /><meta name="feedback-yes" content="feedbackyes.html?topic_url=http://docs.aws.amazon.com/en_us/lambda/latest/dg/with-kafka.html" /><meta name="feedback-no" content="feedbackno.html?topic_url=http://docs.aws.amazon.com/en_us/lambda/latest/dg/with-kafka.html" /><meta name="keywords" content="Lambda,AWS Lambda,serverless,serverless applications,cloud computing,triggers,event,event object,other AWS service,using Lambda with DynamoDB database,using Lambda with SQS queue service,using Lambda with SNS notification service,Kafka,cluster,trigger,configure" /><script type="application/ld+json">
{
    "@context" : "https://schema.org",
    "@type" : "BreadcrumbList",
    "itemListElement" : [
      {
        "@type" : "ListItem",
        "position" : 1,
        "name" : "AWS",
        "item" : "https://aws.amazon.com"
      },
      {
        "@type" : "ListItem",
        "position" : 2,
        "name" : "AWS Lambda",
        "item" : "https://docs.aws.amazon.com/lambda/index.html"
      },
      {
        "@type" : "ListItem",
        "position" : 3,
        "name" : "Developer Guide",
        "item" : "https://docs.aws.amazon.com/lambda/latest/dg"
      },
      {
        "@type" : "ListItem",
        "position" : 4,
        "name" : "Using AWS Lambda with other services",
        "item" : "https://docs.aws.amazon.com/lambda/latest/dg/lambda-services.html"
      },
      {
        "@type" : "ListItem",
        "position" : 5,
        "name" : "Using Lambda with self-managed Apache Kafka",
        "item" : "https://docs.aws.amazon.com/lambda/latest/dg/lambda-services.html"
      }
    ]
}
</script></head><body><div id="main"><div style="display: none"><a href="/pdfs/lambda/latest/dg/lambda-dg.pdf#with-kafka" target="_blank" rel="noopener noreferrer" title="Open PDF"></a></div><div id="breadcrumbs" class="breadcrumb"><a href="https://aws.amazon.com">AWS</a><a href="/index.html">Documentation</a><a href="/lambda/index.html">AWS Lambda</a><a href="welcome.html">Developer Guide</a></div><div id="page-toc-src"><a href="#smaa-sample-event">Example event</a><a href="#smaa-authentication">Kafka cluster authentication</a><a href="#smaa-permissions">Managing API access and permissions</a><a href="#kafka-permissions-errors">Authentication and authorization errors</a><a href="#services-kafka-vpc-config">Network configuration</a><a href="#services-smaa-topic-add">Adding a Kafka cluster as an event source</a><a href="#kafka-using-cluster">Using a Kafka cluster as an event source</a><a href="#services-kafka-stream-poll">Polling and stream starting positions</a><a href="#services-kafka-scaling">Auto scaling of the Kafka event source</a><a href="#kafka-hosting-api-operations">Event source API operations</a><a href="#services-event-errors">Event source errors</a><a href="#services-kafka-metrics">Amazon CloudWatch metrics</a><a href="#services-kafka-parms">Self-managed Apache Kafka configuration parameters</a></div><div id="main-content" class="awsui-util-container"><div id="main-col-body"><awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner><h1 class="topictitle" id="with-kafka">Using Lambda with self-managed Apache Kafka</h1><div class="awsdocs-page-header-container"><awsdocs-page-header></awsdocs-page-header><awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector></div><div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>Note</h6></div><div class="awsdocs-note-text"><p>If you want to send data to a target other than a Lambda function or enrich the data before sending it, see <a href="https://docs.aws.amazon.com/eventbridge/latest/userguide/eb-pipes.html">
    Amazon EventBridge Pipes</a>.</p></div></div><p>Lambda supports <a href="https://kafka.apache.org/" rel="noopener noreferrer" target="_blank"><span>Apache Kafka</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> as an <a href="./invocation-eventsourcemapping.html">event source</a>. Apache Kafka is a an
    open-source event streaming platform that supports workloads such as data pipelines and streaming analytics.</p><p>You can use the AWS managed Kafka service Amazon Managed Streaming for Apache Kafka (Amazon MSK), or a self-managed Kafka cluster. For details
    about using Lambda with Amazon MSK, see <a href="./with-msk.html">Using Lambda with Amazon MSK</a>.</p><p>This topic describes how to use Lambda with a self-managed Kafka cluster. In AWS terminology, a self-managed
    cluster includes non-AWS hosted Kafka clusters. For example, you can host your Kafka cluster with a cloud provider
    such as <a href="https://www.confluent.io/confluent-cloud/" rel="noopener noreferrer" target="_blank"><span>Confluent Cloud</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>.</p><p>Apache Kafka as an event source operates similarly to using Amazon Simple Queue Service (Amazon SQS) or Amazon Kinesis. Lambda internally polls for
    new messages from the event source and then synchronously invokes the target Lambda function. Lambda reads the
    messages in batches and provides these to your function as an event payload. The maximum batch size is configurable.
    (The default is 100 messages.)</p><p>For Kafka-based event sources, Lambda supports processing control parameters, such as batching windows
      and batch size. For more information, see <a href="./invocation-eventsourcemapping.html#invocation-eventsourcemapping-batching">Batching behavior</a>.</p><p>For an example of how to use self-managed Kafka as an event source, see <a href="http://aws.amazon.com/blogs/compute/using-self-hosted-apache-kafka-as-an-event-source-for-aws-lambda/" rel="noopener noreferrer" target="_blank"><span>Using self-hosted Apache Kafka as an
      event source for AWS Lambda</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> on the AWS Compute Blog.</p><div class="highlights" id="inline-topiclist"><h6>Topics</h6><ul><li><a href="#smaa-sample-event">Example event</a></li><li><a href="#smaa-authentication">Kafka cluster authentication</a></li><li><a href="#smaa-permissions">Managing API access and permissions</a></li><li><a href="#kafka-permissions-errors">Authentication and authorization errors</a></li><li><a href="#services-kafka-vpc-config">Network configuration</a></li><li><a href="#services-smaa-topic-add">Adding a Kafka cluster as an event source</a></li><li><a href="#kafka-using-cluster">Using a Kafka cluster as an event source</a></li><li><a href="#services-kafka-stream-poll">Polling and stream starting positions</a></li><li><a href="#services-kafka-scaling">Auto scaling of the Kafka event source</a></li><li><a href="#kafka-hosting-api-operations">Event source API operations</a></li><li><a href="#services-event-errors">Event source mapping errors</a></li><li><a href="#services-kafka-metrics">Amazon CloudWatch metrics</a></li><li><a href="#services-kafka-parms">Self-managed Apache Kafka configuration parameters</a></li></ul></div>
    <h2 id="smaa-sample-event">Example event</h2>
    <p>Lambda sends the batch of messages in the event parameter when it invokes your Lambda function. The event payload
    contains an array of messages. Each array item contains details of the Kafka topic and Kafka partition identifier,
    together with a timestamp and a base64-encoded message.</p>
    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class=""><span>{</span>
   "eventSource": "SelfManagedKafka",
   "bootstrapServers":"b-2.demo-cluster-1.a1bcde.c1.kafka.us-east-1.amazonaws.com:9092,b-1.demo-cluster-1.a1bcde.c1.kafka.us-east-1.amazonaws.com:9092",
   "records":<span>{</span>
      "mytopic-0":[
         <span>{</span>
            "topic":"mytopic",
            "partition":0,
            "offset":15,
            "timestamp":1545084650987,
            "timestampType":"CREATE_TIME",
            "key":"abcDEFghiJKLmnoPQRstuVWXyz1234==",
            "value":"SGVsbG8sIHRoaXMgaXMgYSB0ZXN0Lg==",
            "headers":[
               <span>{</span>
                  "headerKey":[
                     104,
                     101,
                     97,
                     100,
                     101,
                     114,
                     86,
                     97,
                     108,
                     117,
                     101
                  ]
               }
            ]
         }
      ]
   }
}</code></pre>
   
    <h2 id="smaa-authentication">Kafka cluster authentication</h2>
    <p>Lambda supports several methods to authenticate with your self-managed Apache Kafka cluster. Make sure that you configure the
      Kafka cluster to use one of these supported authentication methods. For more information about Kafka security, see
      the <a href="http://kafka.apache.org/documentation.html#security" rel="noopener noreferrer" target="_blank"><span>Security</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> section of the Kafka
      documentation.</p>
    
           
      <h3 id="smaa-auth-vpc">VPC access</h3> 
      <p>If only Kafka users within your VPC access your Kafka brokers, you must configure the Kafka event source for
        Amazon Virtual Private Cloud (Amazon VPC) access.</p>
     
     
      <h3 id="smaa-auth-sasl">SASL/SCRAM authentication</h3> 
      <p>Lambda supports Simple Authentication and Security Layer/Salted Challenge Response Authentication Mechanism
        (SASL/SCRAM) authentication with Transport Layer Security (TLS) encryption (<code class="code">SASL_SSL</code>). Lambda sends the encrypted credentials to authenticate with
        the cluster. Lambda doesn't support SASL/SCRAM with plaintext (<code class="code">SASL_PLAINTEXT</code>). For more information about SASL/SCRAM authentication, see <a href="https://tools.ietf.org/html/rfc5802" rel="noopener noreferrer" target="_blank"><span>RFC 5802</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>.</p> 
      <p>Lambda also supports SASL/PLAIN authentication. Because this mechanism uses clear text credentials, the connection to the server must use TLS encryption to ensure that the credentials are protected.</p>
      <p>For SASL authentication, you store the sign-in credentials as a secret in AWS Secrets Manager. For more information
        about using Secrets Manager, see <a href="https://docs.aws.amazon.com/secretsmanager/latest/userguide/tutorials_basic.html">Tutorial: Create and retrieve a secret</a> in the <em>AWS Secrets Manager User Guide</em>.</p>
      <div class="awsdocs-note awsdocs-important"><div class="awsdocs-note-title"><awsui-icon name="status-warning" variant="error"></awsui-icon><h6>Important</h6></div><div class="awsdocs-note-text"><p>To use Secrets Manager for authentication, secrets must be stored in the same AWS region as your Lambda function.</p></div></div>
     
     
      <h3 id="smaa-auth-mtls">Mutual TLS authentication</h3>
      <p>Mutual TLS (mTLS) provides two-way authentication between the client and server. The client sends a
        certificate to the server for the server to verify the client, and the server sends a certificate to the client
        for the client to verify the server. </p>
      <p>In self-managed Apache Kafka, Lambda acts as the client. You configure a client certificate (as a secret in Secrets Manager) to
        authenticate Lambda with your Kafka brokers. The client certificate must be signed by a CA in the server's trust
        store.</p>
      <p>The Kafka cluster sends a server certificate to Lambda to authenticate the Kafka brokers with Lambda. The
        server certificate can be a public CA certificate or a private CA/self-signed certificate. The public CA
        certificate must be signed by a certificate authority (CA) that's in the Lambda trust store. For a private
        CA/self-signed certificate, you configure the server root CA certificate (as a secret in Secrets Manager). Lambda uses
        the root certificate to verify the Kafka brokers.</p>
      <p>For more information about mTLS, see <a href="http://aws.amazon.com/blogs/compute/introducing-mutual-tls-authentication-for-amazon-msk-as-an-event-source" rel="noopener noreferrer" target="_blank"><span>
        Introducing mutual TLS authentication for Amazon MSK as an event source</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>.</p>   
     
     
      <h3 id="smaa-auth-secret">Configuring the client certificate secret</h3> 
      <p>The CLIENT_CERTIFICATE_TLS_AUTH secret requires a certificate field and a private key field. For an
        encrypted private key, the secret requires a private key password. Both the certificate and private key must be
        in PEM format.</p>
      <div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>Note</h6></div><div class="awsdocs-note-text"><p>Lambda supports the <a href="https://datatracker.ietf.org/doc/html/rfc2898/#section-6.1" rel="noopener noreferrer" target="_blank"><span>PBES1</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> (but not
          PBES2) private key encryption algorithms.</p></div></div>
      <p>The certificate field must contain a list of certificates, beginning with the client certificate, followed
        by any intermediate certificates, and ending with the root certificate. Each certificate must start on a new
        line with the following structure:</p>
      <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">-----BEGIN CERTIFICATE-----  
        &lt;certificate contents&gt;
-----END CERTIFICATE-----      </code></pre> 
      <p>Secrets Manager supports secrets up to 65,536 bytes, which is enough space for long certificate chains.</p>
      <p>The private key must be in <a href="https://datatracker.ietf.org/doc/html/rfc5208" rel="noopener noreferrer" target="_blank"><span>PKCS #8</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>
        format, with the following structure:</p>
      <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">-----BEGIN PRIVATE KEY-----  
         &lt;private key contents&gt;
-----END PRIVATE KEY-----            </code></pre> 
      <p>For an encrypted private key, use the following structure:</p>
      <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">-----BEGIN ENCRYPTED PRIVATE KEY-----  
          &lt;private key contents&gt;
-----END ENCRYPTED PRIVATE KEY-----           </code></pre>
      <p>The following example shows the contents of a secret for mTLS authentication using an encrypted private key.
        For an encrypted private key, include the private key password in the secret.</p>
      <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class=""><span>{</span>"privateKeyPassword":"testpassword",
"certificate":"-----BEGIN CERTIFICATE-----
MIIE5DCCAsygAwIBAgIRAPJdwaFaNRrytHBto0j5BA0wDQYJKoZIhvcNAQELBQAw
...
j0Lh4/+1HfgyE2KlmII36dg4IMzNjAFEBZiCRoPimO40s1cRqtFHXoal0QQbIlxk
cmUuiAii9R0=
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
MIIFgjCCA2qgAwIBAgIQdjNZd6uFf9hbNC5RdfmHrzANBgkqhkiG9w0BAQsFADBb
...
rQoiowbbk5wXCheYSANQIfTZ6weQTgiCHCCbuuMKNVS95FkXm0vqVD/YpXKwA/no
c8PH3PSoAaRwMMgOSA2ALJvbRz8mpg==
-----END CERTIFICATE-----",
"privateKey":"-----BEGIN ENCRYPTED PRIVATE KEY-----
MIIFKzBVBgkqhkiG9w0BBQ0wSDAnBgkqhkiG9w0BBQwwGgQUiAFcK5hT/X7Kjmgp
...
QrSekqF+kWzmB6nAfSzgO9IaoAaytLvNgGTckWeUkWn/V0Ck+LdGUXzAC4RxZnoQ
zp2mwJn2NYB7AZ7+imp0azDZb+8YG2aUCiyqb6PnnA==
-----END ENCRYPTED PRIVATE KEY-----"
}</code></pre>
     
    
     
      <h3 id="smaa-auth-ca-cert">Configuring the server root CA certificate secret</h3>
      <p>You create this secret if your Kafka brokers use TLS encryption with certificates signed by a private CA.
        You can use TLS encryption for VPC, SASL/SCRAM, SASL/PLAIN, or mTLS authentication.</p>      
      <p>The server root CA certificate secret requires a field that contains the Kafka broker's root CA certificate
        in PEM format. The following example shows the structure of the secret.</p>
        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class=""><span>{</span>"certificate":"-----BEGIN CERTIFICATE-----
MIID7zCCAtegAwIBAgIBADANBgkqhkiG9w0BAQsFADCBmDELMAkGA1UEBhMCVVMx
EDAOBgNVBAgTB0FyaXpvbmExEzARBgNVBAcTClNjb3R0c2RhbGUxJTAjBgNVBAoT
HFN0YXJmaWVsZCBUZWNobm9sb2dpZXMsIEluYy4xOzA5BgNVBAMTMlN0YXJmaWVs
ZCBTZXJ2aWNlcyBSb290IENlcnRpZmljYXRlIEF1dG...
-----END CERTIFICATE-----"
}</code></pre> 
      
   
    <h2 id="smaa-permissions">Managing API access and permissions</h2>
    <p>In addition to accessing your self-managed Kafka cluster, your Lambda function needs permissions to perform
      various API actions. You add these permissions to the function's <a href="./lambda-intro-execution-role.html">execution role</a>. If your users need access to any API actions, add the required permissions to the
      identity policy for the AWS Identity and Access Management (IAM) user or role.</p>
    
     
      <h3 id="smaa-api-actions-required">Required Lambda function permissions</h3>
      <p>To create and store logs in a log group in Amazon CloudWatch Logs, your Lambda function must have the following
        permissions in its execution role:</p>
      <div class="itemizedlist">
         
         
         
      <ul class="itemizedlist"><li class="listitem">
          <p><a href="https://docs.aws.amazon.com/AmazonCloudWatchLogs/latest/APIReference/API_CreateLogGroup.html">logs:CreateLogGroup</a></p>
        </li><li class="listitem">
          <p><a href="https://docs.aws.amazon.com/AmazonCloudWatchLogs/latest/APIReference/API_CreateLogStream.html">logs:CreateLogStream</a></p>
        </li><li class="listitem">
          <p><a href="https://docs.aws.amazon.com/AmazonCloudWatchLogs/latest/APIReference/API_PutLogEvents.html">logs:PutLogEvents</a></p>
        </li></ul></div>
     
    
     
    <h3 id="smaa-api-actions-optional">Optional Lambda function permissions</h3>
    <p>Your Lambda function might also need permissions to:</p>
      <div class="itemizedlist">
         
         
         
      <ul class="itemizedlist"><li class="listitem">
          <p>Describe your Secrets Manager secret.</p>
        </li><li class="listitem">
          <p>Access your AWS Key Management Service (AWS KMS) customer managed key.</p>
        </li><li class="listitem">
          <p>Access your Amazon VPC.</p>
        </li></ul></div>
    
     
      <h4 id="smaa-api-actions-vpc">Secrets Manager and AWS KMS permissions</h4>
      <p>Depending on the type of access control that you're configuring for your Kafka brokers, your Lambda function
          might need permission to access your Secrets Manager secret or to decrypt your AWS KMS customer managed key. To access these
          resources, your function's execution role must have the following permissions:</p>
      <div class="itemizedlist">
         
         
      <ul class="itemizedlist"><li class="listitem">
          <p><a href="https://docs.aws.amazon.com/secretsmanager/latest/apireference/API_GetSecretValue.html">secretsmanager:GetSecretValue</a></p>
        </li><li class="listitem">
          <p><a href="https://docs.aws.amazon.com/kms/latest/APIReference/API_Decrypt.html">kms:Decrypt</a></p>
        </li></ul></div>
     
    
     
      <h4 id="smaa-api-actions-vpc">VPC permissions</h4>
      <p>If only users within a VPC can access your self-managed Apache Kafka cluster, your Lambda function must have permission to
          access your Amazon VPC resources. These resources include your VPC, subnets, security groups, and network
          interfaces. To access these resources, your function's execution role must have the following
          permissions:</p>
      <div class="itemizedlist">
         
         
         
         
         
         
      <ul class="itemizedlist"><li class="listitem">
          <p><a href="https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_CreateNetworkInterface.html">ec2:CreateNetworkInterface</a></p>
        </li><li class="listitem">
          <p><a href="https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_DescribeNetworkInterfaces.html">ec2:DescribeNetworkInterfaces</a></p>
        </li><li class="listitem">
          <p><a href="https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_DescribeVpcs.html">ec2:DescribeVpcs</a></p>
        </li><li class="listitem">
          <p><a href="https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_DeleteNetworkInterface.html">ec2:DeleteNetworkInterface</a></p>
        </li><li class="listitem">
          <p><a href="https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_DescribeSubnets.html">ec2:DescribeSubnets</a></p>
        </li><li class="listitem">
          <p><a href="https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_DescribeSecurityGroups.html">ec2:DescribeSecurityGroups</a></p>
        </li></ul></div>
     
   
    
     
      <h3 id="smaa-permissions-add-policy">Adding permissions to your execution role</h3>
      <p>To access other AWS services that your self-managed Apache Kafka cluster uses, Lambda uses the permissions policies that you
        define in your Lambda function's <a href="./lambda-intro-execution-role.html">execution role</a>.</p>
      <p>By default, Lambda is not permitted to perform the required or optional actions for a self-managed Apache Kafka cluster. You
        must create and define these actions in an <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_terms-and-concepts.html#term_trust-policy">IAM trust policy</a>, and
        then attach the policy to your execution role. This example shows how you might create a policy that allows
        Lambda to access your Amazon VPC resources.</p>
      <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class=""><span>{</span>
        "Version":"2012-10-17",
        "Statement":[
           <span>{</span>
              "Effect":"Allow",
              "Action":[
                 "ec2:CreateNetworkInterface",
                 "ec2:DescribeNetworkInterfaces",
                 "ec2:DescribeVpcs",
                 "ec2:DeleteNetworkInterface",
                 "ec2:DescribeSubnets",
                 "ec2:DescribeSecurityGroups"
              ],
              "Resource":"*"
           }
        ]
     }</code></pre>
      <p>For information about creating a JSON policy document in the IAM console, see <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_create-console.html#access_policies_create-json-editor">Creating
          policies on the JSON tab</a> in the <em>IAM User Guide</em>.</p>
     
    
     
      <h3 id="smaa-permissions-add-users">Granting users access with an IAM policy</h3>
      <p>By default, users and roles don't have permission to perform <a href="#kafka-hosting-api-operations">event source API operations</a>. To grant access to users in your
        organization or account, you create or update an identity-based policy. For more information, see <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/access_controlling.html">Controlling access to AWS resources
          using policies</a> in the <em>IAM User Guide</em>.</p>
     
   
    <h2 id="kafka-permissions-errors">Authentication and authorization errors</h2>
    <p>If any of the permissions required to consume data from the Kafka cluster are missing, Lambda displays one of
      the following error messages in the event source mapping under <b>LastProcessingResult</b>.</p>
    <div class="highlights" id="inline-topiclist"><h6>Error messages</h6><ul><li><a href="#kafka-authorize-errors">Cluster failed to authorize Lambda</a></li><li><a href="#kafka-sasl-errors">SASL authentication failed</a></li><li><a href="#kafka-mtls-errors-server">Server failed to authenticate Lambda</a></li><li><a href="#kafka-mtls-errors-lambda">Lambda failed to authenticate server</a></li><li><a href="#kafka-key-errors">Provided certificate or private key is invalid</a></li></ul></div>
     
      <h3 id="kafka-authorize-errors">Cluster failed to authorize Lambda</h3>
      <p>For SASL/SCRAM or mTLS, this error indicates that the provided user doesn't have all of the following
        required Kafka access control list (ACL) permissions:</p>
      <div class="itemizedlist">
         
         
         
         
         
      <ul class="itemizedlist"><li class="listitem">
          <p>DescribeConfigs Cluster</p>
        </li><li class="listitem">
          <p>Describe Group</p>
        </li><li class="listitem">
          <p>Read Group</p>
        </li><li class="listitem">
          <p>Describe Topic</p>
        </li><li class="listitem">
          <p>Read Topic</p>
        </li></ul></div>
      <p>When you create Kafka ACLs with the required <code class="code">kafka-cluster</code> permissions, specify the topic and
        group as resources. The topic name must match the topic in the event source mapping. The group name must match
        the event source mapping's UUID.</p>
      <p>After you add the required permissions to the execution role, it might take several minutes for the changes
        to take effect.</p>
     
     
      <h3 id="kafka-sasl-errors">SASL authentication failed</h3>
      <p>For SASL/SCRAM or SASL/PLAIN, this error indicates that the provided sign-in credentials aren't
        valid.</p>
     
     
      <h3 id="kafka-mtls-errors-server">Server failed to authenticate Lambda</h3>
      <p>This error indicates that the Kafka broker failed to authenticate Lambda. This can occur for any of the
        following reasons:</p>  
      <div class="itemizedlist">
         
         
         
      <ul class="itemizedlist"><li class="listitem"><p>You didn't provide a client certificate for mTLS authentication.</p></li><li class="listitem"><p>You provided a client certificate, but the Kafka brokers aren't configured to use mTLS authentication.</p></li><li class="listitem"><p>A client certificate isn't trusted by the Kafka brokers.</p></li></ul></div>
     
     
      <h3 id="kafka-mtls-errors-lambda">Lambda failed to authenticate server</h3>
      <p>This error indicates that Lambda failed to authenticate the Kafka broker. This can occur for any of the
        following reasons:</p>  
      <div class="itemizedlist">
         
         
         
      <ul class="itemizedlist"><li class="listitem"><p>The Kafka brokers use self-signed certificates or a private CA, but didn't provide the server root CA
          certificate.</p></li><li class="listitem"><p>The server root CA certificate doesn't match the root CA that signed the broker's certificate.</p></li><li class="listitem"><p>Hostname validation failed because the broker's certificate doesn't contain the broker's DNS name or IP address as
            a subject alternative name.</p></li></ul></div>
    
     
      <h3 id="kafka-key-errors">Provided certificate or private key is invalid</h3>
      <p>This error indicates that the Kafka consumer couldn't use the provided certificate or private key. Make sure
        that the certificate and key use PEM format, and that the private key encryption uses a PBES1 algorithm.</p>
     
   
    <h2 id="services-kafka-vpc-config">Network configuration</h2>
    <p>If you configure Amazon VPC access to your Kafka brokers, Lambda must have access to the Amazon VPC resources associated
      with your Kafka cluster. We recommend that you deploy AWS PrivateLink <a href="https://docs.aws.amazon.com/vpc/latest/privatelink/endpoint-services-overview.html">VPC endpoints</a> for Lambda and AWS Security Token Service
      (AWS STS). If the broker uses authentication, also deploy a VPC endpoint for Secrets Manager.</p>
    <p>Alternatively, ensure that the VPC associated with your Kafka cluster includes one NAT gateway per public
      subnet. For more information, see <a href="./configuration-vpc.html#vpc-internet">Internet and service access for VPC-connected functions</a>.</p>
    <p>Configure your Amazon VPC security groups with the following rules (at minimum):</p>
    <div class="itemizedlist">
       
       
       
    <ul class="itemizedlist"><li class="listitem">
        <p>Inbound rules – Allow all traffic on the Kafka broker port for the security groups specified for
          your event source. Kafka uses port 9092 by default.</p>
      </li><li class="listitem">
        <p>Outbound rules – Allow all traffic on port 443 for all destinations. Allow all traffic on the Kafka
          broker port for the security groups specified for your event source. Kafka uses port 9092 by default.</p>
      </li><li class="listitem">
        <p>If you are using VPC endpoints instead of a NAT gateway, the security groups associated with the VPC
          endpoints must allow all inbound traffic on port 443 from the event source's security groups.</p>
      </li></ul></div>
    <p>For more information about configuring the network, see <a href="http://aws.amazon.com/blogs/compute/setting-up-aws-lambda-with-an-apache-kafka-cluster-within-a-vpc/" rel="noopener noreferrer" target="_blank"><span>Setting up AWS Lambda with an
        Apache Kafka cluster within a VPC</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> on the AWS Compute Blog.</p>
   
    <h2 id="services-smaa-topic-add">Adding a Kafka cluster as an event source</h2>
     <p>To create an <a href="./invocation-eventsourcemapping.html">event source mapping</a>, add your Kafka
      cluster as a Lambda function <a href="./gettingstarted-concepts.html#gettingstarted-concepts-trigger">trigger</a> using the Lambda
      console, an <a href="http://aws.amazon.com/getting-started/tools-sdks/" rel="noopener noreferrer" target="_blank"><span>AWS SDK</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>, or the <a href="https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html">AWS Command Line Interface (AWS CLI)</a>.</p>
    <p>This section describes how to create an event source mapping using the Lambda console and the AWS CLI.</p>
    <div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>Note</h6></div><div class="awsdocs-note-text"><p>When you update, disable, or delete an event source mapping for self-managed Apache Kafka, it can take up to 15 minutes for your changes to take effect. 
        Before this period has elapsed, your event source mapping may continue to process events and invoke your function using your previous settings. 
        This is true even when the status of the event source mapping displayed in the console indicates that your changes have been applied.</p></div></div>

     
      <h3 id="services-smaa-prereqs">Prerequisites</h3>
      <div class="itemizedlist">
         
         
      <ul class="itemizedlist"><li class="listitem">
          <p>A self-managed Apache Kafka cluster. Lambda supports Apache Kafka version 0.10.0.0 and later.</p>
        </li><li class="listitem">
          <p>An <a href="./lambda-intro-execution-role.html">execution role</a> with permission to access the AWS resources that your self-managed Kafka
            cluster uses.</p>
        </li></ul></div>
     
    
    
     
      <h3 id="services-smaa-consumer-group-id">Customizable consumer group ID</h3>
      <p>When setting up Kafka as an event source, you can specify a consumer group ID. This consumer group ID is an
    existing identifier for the Kafka consumer group that you want your Lambda function to join. You can use this feature to seamlessly migrate any
    ongoing Kafka record processing setups from other consumers to Lambda.</p>
    <p>If you specify a consumer group ID and there are other active pollers within that consumer group, Kafka distributes messages across
      all consumers. In other words, Lambda doesn't receive all message for the Kafka topic. If you want Lambda to handle all messages in the
      topic, turn off any other pollers in that consumer group.</p>
    <p>Additionally, if you specify a consumer group ID, and Kafka finds a valid existing consumer group with the same ID, Lambda ignores the
      <code class="code">StartingPosition</code> parameter for your event source mapping. Instead, Lambda begins processing records according to the committed
      offset of the consumer group. If you specify a consumer group ID, and Kafka cannot find an existing consumer group, then Lambda configures your
      event source with the specified <code class="code">StartingPosition</code>.</p>
    <p>The consumer group ID that you specify must be unique among all your Kafka event sources. After creating a Kafka event source mapping
      with the consumer group ID specified, you cannot update this value.</p>
     
    
    
     
      <h3 id="services-smaa-trigger">Adding a self-managed Kafka cluster (console)</h3>
      <p>Follow these steps to add your self-managed Apache Kafka cluster and a Kafka topic as a trigger for your Lambda function.</p>
      <div class="procedure"><h6>To add an Apache Kafka trigger to your Lambda function (console)</h6><ol><li>
          <p>Open the <a href="https://console.aws.amazon.com/lambda/home#/functions" rel="noopener noreferrer" target="_blank"><span>Functions page</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> of the Lambda
            console.</p>
        </li><li>
          <p>Choose the name of your Lambda function.</p>
        </li><li>
          <p>Under <b>Function overview</b>, choose <b>Add trigger</b>.</p>
        </li><li>
          <p>Under <b>Trigger configuration</b>, do the following:</p>
          <ol><li>
              <p>Choose the <b>Apache Kafka</b> trigger type.</p>
            </li><li>
              <p>For <b>Bootstrap servers</b>, enter the host and port pair address of a Kafka broker
                in your cluster, and then choose <b>Add</b>. Repeat for each Kafka broker in the
                cluster.</p>
            </li><li>
              <p>For <b>Topic name</b>, enter the name of the Kafka topic used to store records in the
                cluster.</p>
            </li><li>
              <p>(Optional) For <b>Batch size</b>, enter the maximum number of records to receive in a
                single batch.</p>
            </li><li>
              <p>For <b>Batch window</b>, enter the maximum amount of seconds that Lambda spends
                gathering records before invoking the function.</p>
            </li><li>
              <p>(Optional) For <b>Consumer group ID</b>, enter the ID of a Kafka consumer group to join.</p>
            </li><li>
              <p>(Optional) For <b>Starting position</b>, choose <b>Latest</b> to start
                reading the stream from the latest record, <b>Trim horizon</b> to start at the
                earliest available record, or <b>At timestamp</b> to specify a timestamp to start
                reading from.</p>
              <div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>Note</h6></div><div class="awsdocs-note-text"><p><b>At timestamp</b> can only be used be used with Kafka broker versions equal to
                or greater than 0.10.1.0.</p></div></div>
            </li><li>
              <p>(Optional) For <b>VPC</b>, choose the Amazon VPC for your Kafka cluster. Then, choose the
                  <b>VPC subnets</b> and <b>VPC security groups</b>.</p>
              <p>This setting is required if only users within your VPC access your brokers.</p>
              <p></p>
            </li><li>
              <p>(Optional) For <b>Authentication</b>, choose <b>Add</b>, and then do the
                following:</p>
              <ol><li>
                  <p>Choose the access or authentication protocol of the Kafka brokers in your cluster.</p>
                  <ul>
                    <li>
                      <p>If your Kafka broker uses SASL/PLAIN authentication, choose
                          <b>BASIC_AUTH</b>.</p>
                    </li>
                    <li>
                      <p>If your broker uses SASL/SCRAM authentication, choose one of the
                          <b>SASL_SCRAM</b> protocols.</p>
                    </li>
                    <li>
                      <p>If you're configuring mTLS authentication, choose the
                          <b>CLIENT_CERTIFICATE_TLS_AUTH</b> protocol.</p>
                    </li>
                  </ul>
                </li><li>
                  <p>For SASL/SCRAM or mTLS authentication, choose the Secrets Manager secret key that contains the
                    credentials for your Kafka cluster.</p>
                </li></ol>
            </li><li>
              <p>(Optional) For <b>Encryption</b>, choose the Secrets Manager secret containing the root CA
                certificate that your Kafka brokers use for TLS encryption, if your Kafka brokers use certificates
                signed by a private CA.</p>
              <p>This setting applies to TLS encryption for SASL/SCRAM or SASL/PLAIN, and to mTLS
                authentication.</p>
            </li><li>
              <p>To create the trigger in a disabled state for testing (recommended), clear <b>Enable
                  trigger</b>. Or, to enable the trigger immediately, select <b>Enable
                trigger</b>.</p>
            </li></ol>
        </li><li>
          <p>To create the trigger, choose <b>Add</b>.</p>
        </li></ol></div>
     
    
    
     
      <h3 id="services-kafka-aws-cli">Adding a self-managed Kafka cluster (AWS CLI)</h3>
      <p>Use the following example AWS CLI commands to create and view a self-managed Apache Kafka trigger for your Lambda function.</p>
      
       
        <h4 id="services-kafka-aws-cli-create">Using SASL/SCRAM</h4>
        <p>If Kafka users access your Kafka brokers over the internet, specify the Secrets Manager secret that you created
          for SASL/SCRAM authentication. The following example uses the <a href="https://docs.aws.amazon.com/cli/latest/reference/lambda/create-event-source-mapping.html"><code class="code">create-event-source-mapping</code></a> 
AWS CLI command to map a Lambda function named <code class="code">my-kafka-function</code> to a Kafka topic named <code class="code">AWSKafkaTopic</code>.</p>
        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight"><code class="userinput">aws lambda create-event-source-mapping --topics <code class="replaceable">AWSKafkaTopic</code>
          --source-access-configuration Type=SASL_SCRAM_512_AUTH,URI=arn:aws:secretsmanager:us-east-1:<code class="replaceable">01234567890</code>:secret:<code class="replaceable">MyBrokerSecretName</code>
          --function-name arn:aws:lambda:us-east-1:<code class="replaceable">01234567890</code>:function:<code class="replaceable">my-kafka-function</code>
          --self-managed-event-source '<span>{</span>"Endpoints":<span>{</span>"KAFKA_BOOTSTRAP_SERVERS":["<code class="replaceable">abc3.xyz.com:9092</code>", "<code class="replaceable">abc2.xyz.com:9092</code>"]}}'</code>
        </code></pre>
       
       
        <h4 id="services-kafka-aws-cli-create-vpc">Using a VPC</h4>
        <p>If only Kafka users within your VPC access your Kafka brokers, you must specify your VPC, subnets, and VPC
          security group. The following example uses the <a href="https://docs.aws.amazon.com/cli/latest/reference/lambda/create-event-source-mapping.html"><code class="code">create-event-source-mapping</code></a> 
AWS CLI command to map a Lambda function named <code class="code">my-kafka-function</code> to a Kafka topic named <code class="code">AWSKafkaTopic</code>.</p>
        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight"><code class="userinput">aws lambda create-event-source-mapping
          --topics <code class="replaceable">AWSKafkaTopic</code>
          --source-access-configuration '[<span>{</span>"Type": "VPC_SUBNET", "URI": "subnet:<code class="replaceable">subnet-0011001100</code>"},
          <span>{</span>"Type": "VPC_SUBNET", "URI": "subnet:<code class="replaceable">subnet-0022002200</code>"},
          <span>{</span>"Type": "VPC_SECURITY_GROUP", "URI": "security_group:<code class="replaceable">sg-0123456789</code>"}]'
          --function-name arn:aws:lambda:us-east-1:<code class="replaceable">01234567890</code>:function:<code class="replaceable">my-kafka-function</code>
          --self-managed-event-source '<span>{</span>"Endpoints":<span>{</span>"KAFKA_BOOTSTRAP_SERVERS":["<code class="replaceable">abc3.xyz.com:9092</code>",
          "<code class="replaceable">abc2.xyz.com:9092</code>"]}}'</code></code></pre>
       
      
       
        <h4 id="services-kafka-aws-cli-view">Viewing the status using the AWS CLI</h4>
        <p>The following example uses the <a href="https://docs.aws.amazon.com/cli/latest/reference/lambda/get-event-source-mapping.html"><code class="code">get-event-source-mapping</code></a> 
AWS CLI command to describe the status of the event source mapping that you created.</p>
        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight"><code class="userinput">aws lambda get-event-source-mapping
          --uuid <code class="replaceable">dh38738e-992b-343a-1077-3478934hjkfd7</code></code></code></pre>
       
     
   
    <h2 id="kafka-using-cluster">Using a Kafka cluster as an event source</h2>
    <p>When you add your Apache Kafka cluster as a trigger for your Lambda function, the cluster is used as an <a href="./invocation-eventsourcemapping.html">event source</a>.</p>
    <p>Lambda reads event data from the Kafka topics that you specify as <code class="code">Topics</code> in a
      <a href="./API_CreateEventSourceMapping.html">CreateEventSourceMapping</a> request, based on the <code class="code">StartingPosition</code> that you specify. After
      successful processing, your Kafka topic is committed to your Kafka cluster.</p>
    <p>If you specify the <code class="code">StartingPosition</code> as <code class="code">LATEST</code>, Lambda starts reading from the latest
      message in each partition belonging to the topic. Because there can be some delay after trigger configuration
      before Lambda starts reading the messages, Lambda doesn't read any messages produced during this window.</p>
    <p>Lambda processes records from one or more Kafka topic partitions that you specify and sends a JSON payload to
      your function. When more records are available, Lambda continues processing records in batches, based on the
        <code class="code">BatchSize</code> value that you specify in a <a href="./API_CreateEventSourceMapping.html">CreateEventSourceMapping</a> request, until your function
      catches up with the topic.</p>
    <p>If your function returns an error for any of the messages in a batch, Lambda retries the whole batch of
      messages until processing succeeds or the messages expire.</p>
    <div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>Note</h6></div><div class="awsdocs-note-text"><p>While Lambda functions typically have a maximum timeout limit of 15 minutes,
      event source mappings for Amazon MSK, self-managed Apache Kafka, Amazon DocumentDB, and Amazon MQ for ActiveMQ and RabbitMQ only support functions with
      maximum timeout limits of 14 minutes. This constraint ensures that the event source mapping can properly
      handle function errors and retries.</p></div></div>
   
    <h2 id="services-kafka-stream-poll">Polling and stream starting positions</h2>
    <p>Be aware that stream polling during event source mapping creation and updates is eventually consistent.</p>
    <div class="itemizedlist">
       
       
    <ul class="itemizedlist"><li class="listitem">
        <p>During event source mapping creation, it may take several minutes to start polling events from the stream.</p>
      </li><li class="listitem">
        <p>During event source mapping updates, it may take several minutes to stop and restart polling events from the stream.</p>
      </li></ul></div>
    <p>This behavior means that if you specify <code class="code">LATEST</code> as the starting position for the stream, the event source mapping could 
    miss events during creation or updates. To ensure that no events are missed, specify the stream starting position as <code class="code">TRIM_HORIZON</code> 
    or <code class="code">AT_TIMESTAMP</code>.</p>
   
      <h2 id="services-kafka-scaling">Auto scaling of the Kafka event source</h2>
      <p>When you initially create an an Apache Kafka <a href="./invocation-eventsourcemapping.html">event source</a>, Lambda allocates one consumer to process all partitions in the
        Kafka topic. Each consumer has multiple processors running in parallel to handle increased workloads. Additionally, Lambda automatically scales up or down the number of consumers, based on workload. To preserve message
        ordering in each partition, the maximum number of consumers is one consumer per partition in the topic.</p>
      <p>In one-minute intervals, Lambda evaluates the consumer offset lag of all the partitions in the topic. If the lag is
        too high, the partition is receiving messages faster than Lambda can process them. If necessary, Lambda adds or
        removes consumers from the topic. The scaling process of adding or removing consumers occurs within three minutes of evaluation.</p>
      <p>If your target Lambda function is overloaded, Lambda reduces the number of consumers. This action reduces the
      workload on the function by reducing the number of messages that consumers can retrieve and send to the
      function.</p>
      <p>To monitor the throughput of your Kafka topic, you can view the Apache Kafka consumer metrics, such as
        <code class="code">consumer_lag</code> and <code class="code">consumer_offset</code>. To check how many function invocations occur in
      parallel, you can also monitor the <a href="./monitoring-metrics.html#monitoring-metrics-concurrency">concurrency metrics</a> for
      your function.</p>
     
      <h2 id="kafka-hosting-api-operations">Event source API operations</h2>
      <p>When you add your Kafka cluster as an <a href="./invocation-eventsourcemapping.html">event source</a> for your Lambda function using the Lambda console, an
      AWS SDK, or the AWS CLI, Lambda uses APIs to process your request.</p>
      
      <p>To manage an event source with the <a href="https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html">AWS Command Line Interface (AWS CLI)</a> or an <a href="http://aws.amazon.com/getting-started/tools-sdks/" rel="noopener noreferrer" target="_blank"><span>AWS SDK</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>, you can use the following API operations:</p>
    <div class="itemizedlist">
        
       
       
       
       
    <ul class="itemizedlist"><li class="listitem">
        <p> <a href="./API_CreateEventSourceMapping.html">CreateEventSourceMapping</a>  </p>
      </li><li class="listitem">
        <p> <a href="./API_ListEventSourceMappings.html">ListEventSourceMappings</a>  </p>
      </li><li class="listitem">
        <p> <a href="./API_GetEventSourceMapping.html">GetEventSourceMapping</a>  </p>
      </li><li class="listitem">
        <p><a href="./API_UpdateEventSourceMapping.html">UpdateEventSourceMapping</a>  </p>
      </li><li class="listitem">
        <p><a href="./API_DeleteEventSourceMapping.html">DeleteEventSourceMapping</a>  </p>
      </li></ul></div>
      
     
      <h2 id="services-event-errors">Event source mapping errors</h2>
      <p>When you add your Apache Kafka cluster as an <a href="./invocation-eventsourcemapping.html">event source</a> for your Lambda function, if your function encounters an error, your Kafka consumer stops processing records. Consumers of a topic partition are those that subscribe to, read, and process your records. Your other Kafka consumers can continue processing records, provided they don't encounter the same error.</p>
      <p>To determine the cause of a stopped consumer, check the <code class="code">StateTransitionReason</code> field in the response of <code class="code">EventSourceMapping</code>. The following list describes the event source errors that you can receive:</p>
      <div class="variablelist">
         
         
         
         
      <dl>
          <dt><b><span class="term"><code class="code">ESM_CONFIG_NOT_VALID</code></span></b></dt>
          <dd>
            <p>The event source mapping configuration isn't valid.</p>
          </dd>
        
          <dt><b><span class="term"><code class="code">EVENT_SOURCE_AUTHN_ERROR</code></span></b></dt>
          <dd>
            <p>Lambda couldn't authenticate the event source.</p>
          </dd>
        
          <dt><b><span class="term"><code class="code">EVENT_SOURCE_AUTHZ_ERROR</code></span></b></dt>
          <dd>
            <p>Lambda doesn't have the required permissions to access the event source.</p>
          </dd>
        
          <dt><b><span class="term"><code class="code">FUNCTION_CONFIG_NOT_VALID</code></span></b></dt>
          <dd>
            <p>The function configuration isn't valid.</p>
          </dd>
        </dl></div>
      <div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>Note</h6></div><div class="awsdocs-note-text"><p>If your Lambda event records exceed the allowed size limit of 6 MB, they can go
          unprocessed.</p></div></div>
     
      <h2 id="services-kafka-metrics">Amazon CloudWatch metrics</h2>
      <p>Lambda emits the <code class="code">OffsetLag</code> metric while your function processes records. The value of this metric
      is the difference in offset between the last record written to the Kafka event source topic and the last record that your function's 
      consumer group processed. You can use <code class="code">OffsetLag</code> to estimate the latency between when a record is added and when
      your consumer group processes it.</p>
    <p>An increasing trend in <code class="code">OffsetLag</code> can indicate issues with pollers in your function's consumer group. For more information, see
      <a href="./monitoring-metrics.html">Working with Lambda function metrics</a>.</p>
     
      <h2 id="services-kafka-parms">Self-managed Apache Kafka configuration parameters</h2>
      <p>All Lambda event source types share the same <a href="./API_CreateEventSourceMapping.html">CreateEventSourceMapping</a> and <a href="./API_UpdateEventSourceMapping.html">UpdateEventSourceMapping</a>
        API operations. However, only some of the parameters apply to Apache Kafka.</p>
      <div class="table-container"><div class="table-contents"><table id="w917aac81d163c57b5"><thead><tr><th class="table-header" colspan="100"><div class="title">Event source parameters that apply to self-managed Apache Kafka</div></th></tr>
            <tr>
              <th>Parameter</th>
              <th>Required</th>
              <th>Default</th>
              <th>Notes</th>
            </tr>
          </thead>
            <tr>
              <td tabindex="-1">
                <p>BatchSize</p>
              </td>
              <td tabindex="-1">
                <p>N</p>
              </td>
              <td tabindex="-1">
                <p>100</p>
              </td>
              <td tabindex="-1">
                <p>Maximum: 10,000</p>
              </td>
            </tr>
            <tr>
              <td tabindex="-1">
                <p>Enabled</p>
              </td>
              <td tabindex="-1">
                <p>N</p>
              </td>
              <td tabindex="-1">
                <p>Enabled</p>
              </td>
              <td tabindex="-1">
                <p> </p>
              </td>
            </tr>
            <tr>
              <td tabindex="-1">
                <p>FunctionName</p>
              </td>
              <td tabindex="-1">
                <p>Y</p>
              </td>
              <td tabindex="-1">
                <p> </p>
              </td>
              <td tabindex="-1">
                <p> </p>
              </td>
            </tr>
            <tr>
              <td tabindex="-1">
                <p>FilterCriteria</p>
              </td>
              <td tabindex="-1">
                <p>N</p>
              </td>
              <td tabindex="-1">
                <p> </p>
              </td>
              <td tabindex="-1">
                <p><a href="./invocation-eventfiltering.html">Lambda event filtering</a></p>
              </td>
            </tr>
            <tr>
              <td tabindex="-1">
                <p>MaximumBatchingWindowInSeconds</p>
              </td>
              <td tabindex="-1">
                <p>N</p>
              </td>
              <td tabindex="-1">
                <p>500 ms</p>
              </td>
              <td tabindex="-1">
                <p><a href="./invocation-eventsourcemapping.html#invocation-eventsourcemapping-batching">Batching behavior</a></p>
              </td>
            </tr>
            <tr>
              <td tabindex="-1">
                <p>SelfManagedEventSource</p>
              </td>
              <td tabindex="-1">
                <p>Y</p>
              </td>
              <td tabindex="-1"></td>
              <td tabindex="-1">
                <p>List of Kafka Brokers. Can set only on Create</p>
              </td>
            </tr>
            <tr>
              <td tabindex="-1">
                <p>SelfManagedKafkaEventSourceConfig</p>
              </td>
              <td tabindex="-1">
                <p>N</p>
              </td>
              <td tabindex="-1">
                <p>Contains the ConsumerGroupId field which defaults to a unique value.</p>
              </td>
              <td tabindex="-1">
                <p>Can set only on Create</p>
              </td>
            </tr>
            <tr>
              <td tabindex="-1">
                <p>SourceAccessConfigurations</p>
              </td>
              <td tabindex="-1">
                <p>N</p>
              </td>
              <td tabindex="-1">
                <p>No credentials</p>
              </td>
              <td tabindex="-1">
                <p>VPC information or authentication credentials for the cluster </p>
                <p> For SASL_PLAIN, set to BASIC_AUTH</p>
              </td>
            </tr>
            <tr>
              <td tabindex="-1">
                <p>StartingPosition</p>
              </td>
              <td tabindex="-1">
                <p>Y</p>
              </td>
              <td tabindex="-1">
                <p> </p>
              </td>
              <td tabindex="-1">
                <p>AT_TIMESTAMP, TRIM_HORIZON, or LATEST</p>
                <p>Can set only on Create</p>
              </td>
            </tr>
            <tr>
              <td tabindex="-1">
                <p>StartingPositionTimestamp</p>
              </td>
              <td tabindex="-1">
                <p>N</p>
              </td>
              <td tabindex="-1">
                <p> </p>
              </td>
              <td tabindex="-1">
                <p>Required if StartingPosition is set to AT_TIMESTAMP</p>
              </td>
            </tr>
            <tr>
              <td tabindex="-1">
                <p>Topics</p>
              </td>
              <td tabindex="-1">
                <p>Y</p>
              </td>
              <td tabindex="-1">
                <p> </p>
              </td>
              <td tabindex="-1">
                <p>Topic name</p>
                <p>Can set only on Create</p>
              </td>
            </tr>
          </table></div></div>
    <awsdocs-copyright class="copyright-print"></awsdocs-copyright><awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback></div><noscript><div><div><div><div id="js_error_message"><p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="Warning" /> <strong>Javascript is disabled or is unavailable in your browser.</strong></p><p>To use the Amazon Web Services Documentation, Javascript must be enabled. Please refer to your browser's Help pages for instructions.</p></div></div></div></div></noscript><div id="main-col-footer" class="awsui-util-font-size-0"><div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">Document Conventions</a></div><div class="prev-next"><div id="previous" class="prev-link" accesskey="p" href="./services-iotevents.html">IoT Events</div><div id="next" class="next-link" accesskey="n" href="./services-kinesisfirehose.html">Kinesis Firehose</div></div></div><awsdocs-page-utilities></awsdocs-page-utilities></div><div id="quick-feedback-yes" style="display: none;"><div class="title">Did this page help you? - Yes</div><div class="content"><p>Thanks for letting us know we're doing a good job!</p><p>If you've got a moment, please tell us what we did right so we can do more of it.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=Lambda&amp;topic_url=https://docs.aws.amazon.com/en_us/lambda/latest/dg/with-kafka.html"></awsui-button></p></div></div><div id="quick-feedback-no" style="display: none;"><div class="title">Did this page help you? - No</div><div class="content"><p>Thanks for letting us know this page needs work. We're sorry we let you down.</p><p>If you've got a moment, please tell us how we can make the documentation better.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=Lambda&amp;topic_url=https://docs.aws.amazon.com/en_us/lambda/latest/dg/with-kafka.html"></awsui-button></p></div></div></div></body></div></awsdocs-view><div class="page-loading-indicator" id="page-loading-indicator"><awsui-spinner size="large"></awsui-spinner></div></div><div id="tools-panel" dom-region="tools"><awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel></div></awsui-app-layout><awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner></div></body></html>