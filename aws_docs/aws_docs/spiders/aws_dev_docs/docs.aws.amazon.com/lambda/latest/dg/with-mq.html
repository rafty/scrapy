<!DOCTYPE html>
    <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Using Lambda with Amazon MQ - AWS Lambda</title><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="assets_root" content="/assets" /><meta name="target_state" content="with-mq" /><meta name="default_state" content="with-mq" /><link rel="icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="shortcut icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="canonical" href="https://docs.aws.amazon.com/lambda/latest/dg/with-mq.html" /><meta name="description" content="Use a Lambda function with Amazon MQ to process records from a message broker." /><meta name="deployment_region" content="IAD" /><meta name="product" content="AWS Lambda" /><meta name="guide" content="Developer Guide" /><meta name="abstract" content="" /><meta name="guide-locale" content="en_us" /><meta name="tocs" content="toc-contents.json" /><link rel="canonical" href="https://docs.aws.amazon.com/lambda/latest/dg/with-mq.html" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/lambda/latest/dg/with-mq.html" hreflang="id-id" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/lambda/latest/dg/with-mq.html" hreflang="id" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/lambda/latest/dg/with-mq.html" hreflang="de-de" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/lambda/latest/dg/with-mq.html" hreflang="de" /><link rel="alternative" href="https://docs.aws.amazon.com/lambda/latest/dg/with-mq.html" hreflang="en-us" /><link rel="alternative" href="https://docs.aws.amazon.com/lambda/latest/dg/with-mq.html" hreflang="en" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/lambda/latest/dg/with-mq.html" hreflang="es-es" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/lambda/latest/dg/with-mq.html" hreflang="es" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/lambda/latest/dg/with-mq.html" hreflang="fr-fr" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/lambda/latest/dg/with-mq.html" hreflang="fr" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/lambda/latest/dg/with-mq.html" hreflang="it-it" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/lambda/latest/dg/with-mq.html" hreflang="it" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/lambda/latest/dg/with-mq.html" hreflang="ja-jp" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/lambda/latest/dg/with-mq.html" hreflang="ja" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/lambda/latest/dg/with-mq.html" hreflang="ko-kr" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/lambda/latest/dg/with-mq.html" hreflang="ko" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/lambda/latest/dg/with-mq.html" hreflang="pt-br" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/lambda/latest/dg/with-mq.html" hreflang="pt" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_cn/lambda/latest/dg/with-mq.html" hreflang="zh-cn" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_tw/lambda/latest/dg/with-mq.html" hreflang="zh-tw" /><link rel="alternative" href="https://docs.aws.amazon.com/lambda/latest/dg/with-mq.html" hreflang="x-default" /><meta name="feedback-item" content="Lambda" /><meta name="this_doc_product" content="AWS Lambda" /><meta name="this_doc_guide" content="Developer Guide" /><script defer="" src="/assets/r/vendor4.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor3.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor1.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-common.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-doc-page.js?version=2021.12.02"></script><link href="/assets/r/vendor4.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-common.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-doc-page.css?version=2021.12.02" rel="stylesheet" /><script async="" id="awsc-panorama-bundle" type="text/javascript" src="https://prod.pa.cdn.uis.awsstatic.com/panorama-nav-init.js" data-config="{'appEntity':'aws-documentation','region':'us-east-1','service':'lambda'}"></script><meta id="panorama-serviceSubSection" value="Developer Guide" /><meta id="panorama-serviceConsolePage" value="Using Lambda with Amazon MQ" /></head><body class="awsdocs awsui"><div class="awsdocs-container"><awsdocs-header></awsdocs-header><awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)"><div id="guide-toc" dom-region="navigation"><awsdocs-toc></awsdocs-toc></div><div id="main-column" dom-region="content" tabindex="-1"><awsdocs-view class="awsdocs-view"><div id="awsdocs-content"><head><title>Using Lambda with Amazon MQ - AWS Lambda</title><meta name="pdf" content="/pdfs/lambda/latest/dg/lambda-dg.pdf#with-mq" /><meta name="rss" content="lambda-updates.rss" /><meta name="forums" content="http://forums.aws.amazon.com/forum.jspa?forumID=186" /><meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=Lambda&amp;topic_url=http://docs.aws.amazon.com/en_us/lambda/latest/dg/with-mq.html" /><meta name="feedback-yes" content="feedbackyes.html?topic_url=http://docs.aws.amazon.com/en_us/lambda/latest/dg/with-mq.html" /><meta name="feedback-no" content="feedbackno.html?topic_url=http://docs.aws.amazon.com/en_us/lambda/latest/dg/with-mq.html" /><meta name="keywords" content="Lambda,AWS Lambda,serverless,serverless applications,cloud computing,triggers,event,event object,other AWS service,using Lambda with DynamoDB database,using Lambda with SQS queue service,using Lambda with SNS notification service,MQ,broker,ActiveMQ,RabbitMQ" /><script type="application/ld+json">
{
    "@context" : "https://schema.org",
    "@type" : "BreadcrumbList",
    "itemListElement" : [
      {
        "@type" : "ListItem",
        "position" : 1,
        "name" : "AWS",
        "item" : "https://aws.amazon.com"
      },
      {
        "@type" : "ListItem",
        "position" : 2,
        "name" : "AWS Lambda",
        "item" : "https://docs.aws.amazon.com/lambda/index.html"
      },
      {
        "@type" : "ListItem",
        "position" : 3,
        "name" : "Developer Guide",
        "item" : "https://docs.aws.amazon.com/lambda/latest/dg"
      },
      {
        "@type" : "ListItem",
        "position" : 4,
        "name" : "Using AWS Lambda with other services",
        "item" : "https://docs.aws.amazon.com/lambda/latest/dg/lambda-services.html"
      },
      {
        "@type" : "ListItem",
        "position" : 5,
        "name" : "Using Lambda with Amazon MQ",
        "item" : "https://docs.aws.amazon.com/lambda/latest/dg/lambda-services.html"
      }
    ]
}
</script></head><body><div id="main"><div style="display: none"><a href="/pdfs/lambda/latest/dg/lambda-dg.pdf#with-mq" target="_blank" rel="noopener noreferrer" title="Open PDF"></a></div><div id="breadcrumbs" class="breadcrumb"><a href="https://aws.amazon.com">AWS</a><a href="/index.html">Documentation</a><a href="/lambda/index.html">AWS Lambda</a><a href="welcome.html">Developer Guide</a></div><div id="page-toc-src"><a href="#services-mq-configure">Lambda consumer group</a><a href="#events-mq-permissions">Execution role permissions</a><a href="#services-mq-networkconfiguration">Network configuration</a><a href="#services-mq-eventsourcemapping">Configuring a broker as an event source</a><a href="#services-mq-api">Event source mapping API</a><a href="#services-mq-errors">Event source mapping errors</a><a href="#services-mq-params">Amazon MQ and RabbitMQ configuration parameters</a></div><div id="main-content" class="awsui-util-container"><div id="main-col-body"><awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner><h1 class="topictitle" id="with-mq">Using Lambda with Amazon MQ</h1><div class="awsdocs-page-header-container"><awsdocs-page-header></awsdocs-page-header><awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector></div><div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>Note</h6></div><div class="awsdocs-note-text"><p>If you want to send data to a target other than a Lambda function or enrich the data before sending it, see <a href="https://docs.aws.amazon.com/eventbridge/latest/userguide/eb-pipes.html">
    Amazon EventBridge Pipes</a>.</p></div></div><p>Amazon MQ is a managed message broker service for <a href="https://activemq.apache.org/" rel="noopener noreferrer" target="_blank"><span>Apache ActiveMQ</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>
    and <a href="https://www.rabbitmq.com" rel="noopener noreferrer" target="_blank"><span>RabbitMQ</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>. A <em>message broker</em> enables software
    applications and components to communicate using various programming languages, operating systems, and formal
    messaging protocols through either topic or queue event destinations.</p><p>Amazon MQ can also manage Amazon Elastic Compute Cloud (Amazon EC2) instances on your behalf by installing ActiveMQ or RabbitMQ brokers and by providing
    different network topologies and other infrastructure needs.</p><p>You can use a Lambda function to process records from your Amazon MQ message broker. Lambda invokes your function
    through an <a href="./invocation-eventsourcemapping.html">event source mapping</a>, a Lambda resource that reads
    messages from your broker and invokes the function <a href="./invocation-sync.html">synchronously</a>.</p><p>The Amazon MQ event source mapping has the following configuration restrictions:</p><div class="itemizedlist">
   
	 
     
     
     
     
     
     
  <ul class="itemizedlist"><li class="listitem">
    <p>Concurrency – Lambda functions that use an Amazon MQ event source mapping have a default maximum <a href="./lambda-concurrency.html">concurrency</a> 
      setting. For ActiveMQ, the Lambda service limits the number of concurrent execution environments to five. For RabbitMQ, the number of concurrent 
      execution environments is limited to 1. Even if you change your function's reserved or provisioned concurrency settings, the Lambda 
    service won't make more execution environments available. To request an increase in the default maximum concurremcy, contact AWS Support.</p>
  </li><li class="listitem"><p>Cross account – Lambda does not support cross-account processing. You cannot use Lambda to process records
        from an Amazon MQ message broker that is in a different AWS account.</p></li><li class="listitem">
      <p>Authentication – For ActiveMQ, only the ActiveMQ <a href="https://activemq.apache.org/security#simple-authentication-plugin" rel="noopener noreferrer" target="_blank"><span>SimpleAuthenticationPlugin</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> is
        supported. For RabbitMQ, only the <a href="https://www.rabbitmq.com/access-control.html#mechanisms" rel="noopener noreferrer" target="_blank"><span>PLAIN</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> authentication mechanism is supported. Users must use AWS Secrets Manager to manage their credentials.
        For more information about ActiveMQ authentication, see <a href="https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/security-authentication-authorization.html">Integrating ActiveMQ brokers
          with LDAP</a> in the <em>Amazon MQ Developer Guide</em>.</p>
    </li><li class="listitem">
      <p>Connection quota – Brokers have a maximum number of allowed connections per wire-level protocol. This
        quota is based on the broker instance type. For more information, see the <a href="https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/amazon-mq-limits.html#broker-limits">Brokers</a>
        section of <b>Quotas in Amazon MQ</b> in the
          <em>Amazon MQ Developer Guide</em>.</p>
    </li><li class="listitem">
      <p>Connectivity – You can create brokers in a public or private virtual private cloud (VPC). For private VPCs, your Lambda function needs access to the VPC to receive messages. For more information, see <a href="#services-mq-networkconfiguration">Network configuration</a> later in this
        topic.</p>
    </li><li class="listitem">
      <p>Event destinations – Only queue destinations are supported. However, you can use a virtual topic,
        which behaves  as a topic internally while interacting with Lambda as a queue. For more information, see <a href="https://activemq.apache.org/virtual-destinations" rel="noopener noreferrer" target="_blank"><span>Virtual Destinations</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>
        on the Apache ActiveMQ website, and <a href="https://www.rabbitmq.com/vhosts.html" rel="noopener noreferrer" target="_blank"><span>Virtual Hosts</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>
        on the RabbitMQ website.</p>
    </li><li class="listitem">
      <p>Network topology – For ActiveMQ, only one single-instance or standby broker is supported per event source mapping.
        For RabbitMQ, only one single-instance broker or cluster deployment is supported per event source mapping.
        Single-instance brokers require a failover endpoint. For more information about these broker deployment modes, see
        <a href="https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/amazon-mq-broker-architecture.html">Active MQ Broker Architecture</a> and
        <a href="https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/rabbitmq-broker-architecture.html">Rabbit MQ Broker Architecture</a>in the <em>Amazon MQ Developer Guide</em>.</p>
    </li><li class="listitem">
      <p>Protocols – Supported protocols depend on the type of Amazon MQ integration.</p>
          <div class="itemizedlist">
             
             
          <ul class="itemizedlist"><li class="listitem"><p>For ActiveMQ integrations, Lambda consumes messages using the OpenWire/Java Message Service (JMS) protocol. No other protocols are supported for consuming messages. Within the JMS protocol, only <a href="https://activemq.apache.org/maven/apidocs/org/apache/activemq/command/ActiveMQTextMessage.html" rel="noopener noreferrer" target="_blank"><span><code class="code">TextMessage</code></span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> and <a href="https://activemq.apache.org/maven/apidocs/org/apache/activemq/command/ActiveMQBytesMessage.html" rel="noopener noreferrer" target="_blank"><span><code class="code">BytesMessage</code></span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> are supported. Lambda also supports JMS custom properties. For more information about the OpenWire protocol, see
              <a href="https://activemq.apache.org/openwire.html" rel="noopener noreferrer" target="_blank"><span>OpenWire</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> on the Apache ActiveMQ website.</p></li><li class="listitem"><p>For RabbitMQ integrations, Lambda consumes messages using the AMQP 0-9-1 protocol. No other protocols are supported
            for consuming messages. For more information about RabbitMQ's implementation of the AMQP 0-9-1 protocol, see
              <a href="https://www.rabbitmq.com/amqp-0-9-1-reference.html" rel="noopener noreferrer" target="_blank"><span>AMQP 0-9-1 Complete Reference
              Guide</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> on the RabbitMQ website.</p></li></ul></div>
    </li></ul></div><p>Lambda automatically supports the latest versions of ActiveMQ and RabbitMQ that Amazon MQ supports. For the latest
    supported versions, see <a href="https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/amazon-mq-release-notes.html">Amazon MQ release notes</a> in the
      <em>Amazon MQ Developer Guide</em>.</p><div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>Note</h6></div><div class="awsdocs-note-text"><p>By default, Amazon MQ has a weekly maintenance window for brokers. During that
      window of time, brokers are unavailable. For brokers without standby, Lambda cannot process any messages during that window.</p></div></div><div class="highlights" id="inline-topiclist"><h6>Sections</h6><ul><li><a href="#services-mq-configure">Lambda consumer group</a></li><li><a href="#events-mq-permissions">Execution role permissions</a></li><li><a href="#services-mq-networkconfiguration">Network configuration</a></li><li><a href="#services-mq-eventsourcemapping">Configuring a broker as an event source</a></li><li><a href="#services-mq-api">Event source mapping API</a></li><li><a href="#services-mq-errors">Event source mapping errors</a></li><li><a href="#services-mq-params">Amazon MQ and RabbitMQ configuration parameters</a></li></ul></div>
    <h2 id="services-mq-configure">Lambda consumer group</h2>
    
    <p>To interact with Amazon MQ, Lambda creates a consumer group which can read from your Amazon MQ brokers. The consumer
      group is created with the same ID as the event source mapping UUID.</p>
    <p>For Amazon MQ event sources, Lambda batches records together and sends them to your function in a single payload.
      To control behavior, you can configure the batching window and batch size. Lambda pulls messages until it processes
      the payload size maximum of 6 MB, the batching window expires, or the number of records reaches the full batch
      size. For more information, see <a href="./invocation-eventsourcemapping.html#invocation-eventsourcemapping-batching">Batching behavior</a>.</p>
    <p>The consumer group retrieves the messages as a BLOB of bytes, base64-encodes them into a single JSON payload, and then invokes your function. If your function returns an error for any of the messages in a batch, Lambda retries the
      whole batch of messages until processing succeeds or the messages expire.</p>
    <div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>Note</h6></div><div class="awsdocs-note-text"><p>While Lambda functions typically have a maximum timeout limit of 15 minutes,
      event source mappings for Amazon MSK, self-managed Apache Kafka, Amazon DocumentDB, and Amazon MQ for ActiveMQ and RabbitMQ only support functions with
      maximum timeout limits of 14 minutes. This constraint ensures that the event source mapping can properly
      handle function errors and retries.</p></div></div>
    <p>You can monitor a given function's concurrency usage using the <code class="code">ConcurrentExecutions</code> metric in
      Amazon CloudWatch. For more information about concurrency, see <a href="./configuration-concurrency.html">Configuring reserved concurrency</a>.</p>
    
    <div class="example"><h6>Example Amazon MQ record events</h6><div class="example-contents"><awsdocs-tabs><dl style="display: none">
        <dt>ActiveMQ</dt><dd tab-id="activemq">
            <pre class="programlisting"><div class="code-btn-container"></div><code class="nohighlight"><span>{</span>
   "eventSource": "aws:mq",
   "eventSourceArn": "arn:aws:mq:us-west-2:111122223333:broker:test:b-9bcfa592-423a-4942-879d-eb284b418fc8",
   "messages": [
      <span>{</span> 
        "messageID": "ID:b-9bcfa592-423a-4942-879d-eb284b418fc8-1.mq.us-west-2.amazonaws.com-37557-1234520418293-4:1:1:1:1", 
        "messageType": "jms/text-message",
        "deliveryMode": 1,
        "replyTo": null,
        "type": null,
        "expiration": "60000",
        "priority": 1,
        "correlationId": "myJMSCoID",
        "redelivered": false,
        "destination": <span>{</span> 
          "physicalName": "testQueue" 
        },
        "data":"QUJDOkFBQUE=",
        "timestamp": 1598827811958,
        "brokerInTime": 1598827811958, 
        "brokerOutTime": 1598827811959, 
        "properties": <span>{</span>
          "index": "1",
          "doAlarm": "false",
          "myCustomProperty": "value"
        }
      },
      <span>{</span> 
        "messageID": "ID:b-9bcfa592-423a-4942-879d-eb284b418fc8-1.mq.us-west-2.amazonaws.com-37557-1234520418293-4:1:1:1:1",
        "messageType": "jms/bytes-message",
        "deliveryMode": 1,
        "replyTo": null,
        "type": null,
        "expiration": "60000",
        "priority": 2,
        "correlationId": "myJMSCoID1",
        "redelivered": false,
        "destination": <span>{</span> 
          "physicalName": "testQueue" 
        },
        "data":"LQaGQ82S48k=",
        "timestamp": 1598827811958,
        "brokerInTime": 1598827811958, 
        "brokerOutTime": 1598827811959, 
        "properties": <span>{</span>
          "index": "1",
          "doAlarm": "false",
          "myCustomProperty": "value"
        }
      }
   ]
}</code></pre>
          </dd>
        <dt>RabbitMQ</dt><dd tab-id="rabbitmq">
            <pre class="programlisting"><div class="code-btn-container"></div><code class="nohighlight">
<span>{</span>
  "eventSource": "aws:rmq",
  "eventSourceArn": "arn:aws:mq:us-west-2:111122223333:broker:pizzaBroker:b-9bcfa592-423a-4942-879d-eb284b418fc8",
  "rmqMessagesByQueue": <span>{</span>
    "pizzaQueue::/": [
      <span>{</span>
        "basicProperties": <span>{</span>
          "contentType": "text/plain",
          "contentEncoding": null,
          "headers": <span>{</span>
            "header1": <span>{</span>
              "bytes": [
                118,
                97,
                108,
                117,
                101,
                49
              ]
            },
            "header2": <span>{</span>
              "bytes": [
                118,
                97,
                108,
                117,
                101,
                50
              ]
            },
            "numberInHeader": 10
          },
          "deliveryMode": 1,
          "priority": 34,
          "correlationId": null,
          "replyTo": null,
          "expiration": "60000",
          "messageId": null,
          "timestamp": "Jan 1, 1970, 12:33:41 AM",
          "type": null,
          "userId": "AIDACKCEVSQ6C2EXAMPLE",
          "appId": null,
          "clusterId": null,
          "bodySize": 80
        },
        "redelivered": false,
        "data": "eyJ0aW1lb3V0IjowLCJkYXRhIjoiQ1pybWYwR3c4T3Y0YnFMUXhENEUifQ=="
      }
    ]
  }
}
            </code></pre>
          </dd>
      </dl></awsdocs-tabs><div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>Note</h6></div><div class="awsdocs-note-text"><p>In the RabbitMQ example, <code class="code">pizzaQueue</code> is the name of the RabbitMQ queue, and <code class="code">/</code> is the
          name of the virtual host. When receiving messages, the event source lists messages under
          <code class="code">pizzaQueue::/</code>.</p></div></div></div></div>
   
    <h2 id="events-mq-permissions">Execution role permissions</h2>
    <p>To read records from an Amazon MQ broker, your Lambda function needs the following permissions added to its
      <a href="./lambda-intro-execution-role.html">execution role</a>:</p>
    <div class="itemizedlist">
       
       
       
       
       
       
       
       
       
       
       
    <ul class="itemizedlist"><li class="listitem">
        <p><a href="https://docs.aws.amazon.com/amazon-mq/latest/api-reference/brokers-broker-id.html#brokers-broker-id-http-methods">mq:DescribeBroker</a></p>
      </li><li class="listitem">
        <p><a href="https://docs.aws.amazon.com/secretsmanager/latest/apireference/API_GetSecretValue.html">secretsmanager:GetSecretValue</a></p>
      </li><li class="listitem">
        <p><a href="https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_CreateNetworkInterface.html">ec2:CreateNetworkInterface</a></p>
      </li><li class="listitem">
        <p><a href="https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_DeleteNetworkInterface.html">ec2:DeleteNetworkInterface</a></p>
      </li><li class="listitem">
        <p><a href="https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_DescribeNetworkInterfaces.html">ec2:DescribeNetworkInterfaces</a></p>
      </li><li class="listitem">
        <p><a href="https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_DescribeSecurityGroups.html">ec2:DescribeSecurityGroups</a></p>
      </li><li class="listitem">
        <p><a href="https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_DescribeSubnets.html">ec2:DescribeSubnets</a></p>
      </li><li class="listitem">
        <p><a href="https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_DescribeVpcs.html">ec2:DescribeVpcs</a></p>
      </li><li class="listitem">
        <p><a href="https://docs.aws.amazon.com/AmazonCloudWatchLogs/latest/APIReference/API_CreateLogGroup.html">logs:CreateLogGroup</a></p>
      </li><li class="listitem">
        <p><a href="https://docs.aws.amazon.com/AmazonCloudWatchLogs/latest/APIReference/API_CreateLogStream.html">logs:CreateLogStream</a></p>
      </li><li class="listitem">
        <p><a href="https://docs.aws.amazon.com/AmazonCloudWatchLogs/latest/APIReference/API_PutLogEvents.html">logs:PutLogEvents</a></p>
      </li></ul></div>
   <div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>Note</h6></div><div class="awsdocs-note-text"><p>When using an encrypted customer managed key, add the <code class="code"><a href="https://docs.aws.amazon.com/msk/1.0/apireference/clusters-clusterarn-bootstrap-brokers.html#clusters-clusterarn-bootstrap-brokersget">kms:Decrypt</a></code> permission as well.</p></div></div>
   
    <h2 id="services-mq-networkconfiguration">Network configuration</h2>
    <p>By default, when you create an Amazon MQ broker, the <code class="code">PubliclyAccessible</code> flag is set to false. For your broker to receive a public 
      IP address, you must set the <code class="code">PubliclyAccessible</code> flag to true.</p>
    <p>To give Lambda full access to your broker through your event source mapping, either your broker must use a public endpoint 
      (public IP address), or you must provide access to the Amazon VPC you created the broker in. Best practice for using Amazon MQ with Lambda is to use private 
      endpoints and to give your Lambda function access to your broker's VPC. See <a href="https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/using-amazon-mq-securely.html#prefer-brokers-without-public-accessibility">Prefer brokers without public accessibility</a> 
    in the <em>Amazon MQ Developer Guide</em> for more information.</p> 
    <p>Note that when you add Amazon MQ as a trigger, Lambda assumes the VPC settings of the Amazon MQ broker, not the Lambda function's VPC settings. For your 
      Lambda function to access the VPC with your Amazon MQ broker, do one of the following:</p>
    <div class="itemizedlist">
       
       
    <ul class="itemizedlist"><li class="listitem">
        <p>Configure a NAT gateway on each public subnet in the VPC containing your Amazon MQ broker. For more information, see <a href="./configuration-vpc.html#vpc-internet">Internet and service access for VPC-connected functions</a>.</p>
      </li><li class="listitem">
        <p>Create a connection between the Amazon VPC containing your Amazon MQ broker and a Lambda VPC endpoint. Your Amazon VPC must also connect to AWS Security Token Service (AWS STS) and Secrets Manager endpoints. For 
          more information, see <a href="./configuration-vpc-endpoints.html">Connecting inbound interface VPC endpoints for Lambda</a>.</p>
      </li></ul></div>
    <p>You must also configure the following Amazon VPC security group rules on your VPC:</p>
    <div class="itemizedlist">
       
       
    <ul class="itemizedlist"><li class="listitem">
        <p>Inbound rules – Allow all traffic on the broker port for the security group specified for your event source from within its own security 
          group. ActiveMQ uses port 61617 by default and RabbitMQ uses port 5671 by default.</p>
      </li><li class="listitem">
        <p>Outbound rules – Allow all traffic on port 443 for all destinations. Allow all traffic on the broker port for within its own security 
          group. ActiveMQ uses port 61617 by default and RabbitMQ uses port 5671 by default.</p>
      </li></ul></div>
    <p>If you use VPC endpoints instead of a NAT gateway, the security groups associated with the VPC endpoints must allow all inbound traffic on 
      port 443 from the event source's security groups.</p>
   
    <h2 id="services-mq-eventsourcemapping">Configuring a broker as an event source</h2>
    
    <p>Create
      an <a href="./invocation-eventsourcemapping.html">event source mapping</a> to tell Lambda to
      send records from an Amazon MQ broker to a Lambda function. You can create multiple event source mappings to process
      the same data with multiple functions, or to process items from multiple sources with a single function.</p>
    <p>To configure your function to read from Amazon MQ, create an <b>MQ</b> trigger in the Lambda
      console.</p>
    
    <div class="procedure"><h6>To create a trigger</h6><ol><li><p>Open the <a href="https://console.aws.amazon.com/lambda/home#/functions" rel="noopener noreferrer" target="_blank"><span>Functions page</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> of the Lambda console.</p></li><li>
        <p>Choose the name of a function.</p>
      </li><li>
        <p>Under <b>Function overview</b>, choose <b>Add trigger</b>.</p>
      </li><li>
        <p>Choose a trigger type.</p>
      </li><li>
        <p>Configure the required options, and then choose <b>Add</b>.</p>
      </li></ol></div>
    
    <p>Lambda supports the following options for Amazon MQ event sources:</p>
    <div class="itemizedlist">
       
       
       
       
       
    <ul class="itemizedlist"><li class="listitem">
        <p><b>MQ broker</b> – Select an Amazon MQ broker.</p>
      </li><li class="listitem">
        <p><b>Batch size</b> – Set the maximum number of messages to retrieve in a single
          batch.</p>
      </li><li class="listitem">
        <p><b>Queue name</b> – Enter the Amazon MQ queue to consume.</p>
      </li><li class="listitem">
        <p><b>Source access configuration</b> – Enter virtual host information and the Secrets Manager
          secret that stores your broker credentials.</p>
      </li><li class="listitem">
        <p><b>Enable trigger</b> – Disable the trigger to stop processing records.</p>
      </li></ul></div>
    <p>To enable or disable the trigger (or delete it), choose the <b>MQ</b> trigger in the designer. To reconfigure the trigger, use the event source mapping API
      operations.</p>
   
    <h2 id="services-mq-api">Event source mapping API</h2>
    
    
    <p>To manage an event source with the <a href="https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html">AWS Command Line Interface (AWS CLI)</a> or an <a href="http://aws.amazon.com/getting-started/tools-sdks/" rel="noopener noreferrer" target="_blank"><span>AWS SDK</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>, you can use the following API operations:</p>
    <div class="itemizedlist">
        
       
       
       
       
    <ul class="itemizedlist"><li class="listitem">
        <p> <a href="./API_CreateEventSourceMapping.html">CreateEventSourceMapping</a>  </p>
      </li><li class="listitem">
        <p> <a href="./API_ListEventSourceMappings.html">ListEventSourceMappings</a>  </p>
      </li><li class="listitem">
        <p> <a href="./API_GetEventSourceMapping.html">GetEventSourceMapping</a>  </p>
      </li><li class="listitem">
        <p><a href="./API_UpdateEventSourceMapping.html">UpdateEventSourceMapping</a>  </p>
      </li><li class="listitem">
        <p><a href="./API_DeleteEventSourceMapping.html">DeleteEventSourceMapping</a>  </p>
      </li></ul></div>
    
    <div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>Note</h6></div><div class="awsdocs-note-text"><p>When you update, disable, or delete an event source mapping for Amazon MQ, it can take up to 15 minutes for your changes to take effect. 
        Before this period has elapsed, your event source mapping may continue to process events and invoke your function using your previous 
        settings. This is true even when the status of the event source mapping displayed in the console indicates that your changes have been applied.</p></div></div>
    <p>To create the event source mapping with the AWS Command Line Interface (AWS CLI), use the <a href="https://docs.aws.amazon.com/cli/latest/reference/lambda/create-event-source-mapping.html"><code class="code">create-event-source-mapping</code></a> command.</p>
    <p>The following example AWS CLI command creates an event source which maps a Lambda function named
        <code class="code">MQ-Example-Function</code> to an Amazon MQ RabbitMQ-based broker named <code class="code">ExampleMQBroker</code>. The command also
      provides the virtual host name and a Secrets Manager secret ARN that stores the broker
      credentials.</p>
    <pre class="programlisting"><div class="code-btn-container"></div><code class="nohighlight"><code class="userinput">aws lambda create-event-source-mapping \
--event-source-arn arn:aws:mq:<code class="replaceable">us-east-1:123456789012:broker:ExampleMQBroker:b-24cacbb4-b295-49b7-8543-7ce7ce9dfb98</code> \
--function-name arn:aws:lambda:<code class="replaceable">us-east-1:123456789012:function:MQ-Example-Function</code> \
--queues <code class="replaceable">ExampleQueue</code> \
--source-access-configuration Type=VIRTUAL_HOST,URI="/" Type=BASIC_AUTH,URI=arn:aws:secretsmanager:<code class="replaceable">us-east-1:123456789012:secret:ExampleMQBrokerUserPassword-xPBMTt</code> \</code></code></pre>
    <p>You should see the following output:</p>
<pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class=""><span>{</span>
    "UUID": "91eaeb7e-c976-1234-9451-8709db01f137",
    "BatchSize": 100,
    "EventSourceArn": "arn:aws:mq:us-east-1:123456789012:broker:ExampleMQBroker:b-b4d492ef-bdc3-45e3-a781-cd1a3102ecca",
    "FunctionArn": "arn:aws:lambda:us-east-1:123456789012:function:MQ-Example-Function",
    "LastModified": 1601927898.741,
    "LastProcessingResult": "No records processed",
    "State": "Creating",
    "StateTransitionReason": "USER_INITIATED",
    "Queues": [
        "ExampleQueue"
    ],
    "SourceAccessConfigurations": [
        <span>{</span>
            "Type": "BASIC_AUTH",
            "URI": "arn:aws:secretsmanager:us-east-1:123456789012:secret:ExampleMQBrokerUserPassword-xPBMTt"
        }
    ]
}</code></pre>
    <p>Using the <code class="code"><a href="https://docs.aws.amazon.com/cli/latest/reference/lambda/update-event-source-mapping.html">update-event-source-mapping</a></code> command, you can configure additional options such as how Lambda
      processes batches and to specify when to discard records that cannot be processed. The following example command
      updates an event source mapping to have a batch size of 2.</p>
    <pre class="programlisting"><div class="code-btn-container"></div><code class="nohighlight"><code class="userinput">aws lambda update-event-source-mapping \
--uuid <code class="replaceable">91eaeb7e-c976-1234-9451-8709db01f137</code> \
--batch-size <code class="replaceable">2</code></code></code></pre>
    <p>You should see the following output:</p>
<pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class=""><span>{</span>
    "UUID": "91eaeb7e-c976-1234-9451-8709db01f137",
    "BatchSize": 2,
    "EventSourceArn": "arn:aws:mq:us-east-1:123456789012:broker:ExampleMQBroker:b-b4d492ef-bdc3-45e3-a781-cd1a3102ecca",
    "FunctionArn": "arn:aws:lambda:us-east-1:123456789012:function:MQ-Example-Function",
    "LastModified": 1601928393.531,
    "LastProcessingResult": "No records processed",
    "State": "Updating",
    "StateTransitionReason": "USER_INITIATED"
} </code></pre>
    <p>Lambda updates these settings asynchronously. The output will not reflect changes until this process completes.
      To view the current status of your resource, use the <a href="https://docs.aws.amazon.com/cli/latest/reference/lambda/get-event-source-mapping.html"><code class="code">get-event-source-mapping</code></a>
      command.</p>
    <pre class="programlisting"><div class="code-btn-container"></div><code class="nohighlight"><code class="userinput">aws lambda get-event-source-mapping \
--uuid <code class="replaceable">91eaeb7e-c976-4939-9451-8709db01f137</code></code></code></pre>
    <p>You should see the following output:</p>
<pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class=""><span>{</span>
    "UUID": "91eaeb7e-c976-4939-9451-8709db01f137",
    "BatchSize": 2,
    "EventSourceArn": "arn:aws:mq:us-east-1:123456789012:broker:ExampleMQBroker:b-b4d492ef-bdc3-45e3-a781-cd1a3102ecca",
    "FunctionArn": "arn:aws:lambda:us-east-1:123456789012:function:MQ-Example-Function",
    "LastModified": 1601928393.531,
    "LastProcessingResult": "No records processed",
    "State": "Enabled",
    "StateTransitionReason": "USER_INITIATED"
}</code></pre>
   
    <h2 id="services-mq-errors">Event source mapping errors</h2>
    <p>When a Lambda function encounters an unrecoverable error, your Amazon MQ consumer stops processing records. Any
      other consumers can continue processing, provided that they do not encounter the same error. To determine the
      potential cause of a stopped consumer, check the <code class="code">StateTransitionReason</code> field in the return details of
      your <code class="code">EventSourceMapping</code> for one of the following codes:</p>
    <div class="variablelist">
       
       
       
       
    <dl>
        <dt><b><span class="term"><code class="code">ESM_CONFIG_NOT_VALID</code></span></b></dt>
        <dd>
          <p>The event source mapping configuration is not valid.</p>
        </dd>
      
        <dt><b><span class="term"><code class="code">EVENT_SOURCE_AUTHN_ERROR</code></span></b></dt>
        <dd>
          <p>Lambda failed to authenticate the event source.</p>
        </dd>
      
        <dt><b><span class="term"><code class="code">EVENT_SOURCE_AUTHZ_ERROR</code></span></b></dt>
        <dd>
          <p>Lambda does not have the required permissions to access the event source.</p>
        </dd>
      
        <dt><b><span class="term"><code class="code">FUNCTION_CONFIG_NOT_VALID</code></span></b></dt>
        <dd>
          <p>The function's configuration is not valid.</p>
        </dd>
      </dl></div>
    <p>Records also go unprocessed if Lambda drops
      them due to their size. The size limit for Lambda records is 6 MB. To
      redeliver messages upon function error, you can use a dead-letter queue (DLQ). For more information, see <a href="https://activemq.apache.org/message-redelivery-and-dlq-handling" rel="noopener noreferrer" target="_blank"><span>Message Redelivery and
        DLQ Handling</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> on the Apache ActiveMQ website and <a href="https://www.rabbitmq.com/reliability.html" rel="noopener noreferrer" target="_blank"><span>Reliability Guide</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> on the RabbitMQ
      website.</p>
    <div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>Note</h6></div><div class="awsdocs-note-text"><p>Lambda does not support custom redelivery policies. Instead, Lambda uses a policy with the default values from the <a href="https://activemq.apache.org/redelivery-policy" rel="noopener noreferrer" target="_blank"><span>Redelivery Policy</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> page on the Apache ActiveMQ website, with <code class="code">maximumRedeliveries</code> set to 5.</p></div></div>
   
    <h2 id="services-mq-params">Amazon MQ and RabbitMQ configuration parameters</h2>
    <p>All Lambda event source types share the same <a href="./API_CreateEventSourceMapping.html">CreateEventSourceMapping</a> and <a href="./API_UpdateEventSourceMapping.html">UpdateEventSourceMapping</a>
      API operations. However, only some of the parameters apply to Amazon MQ and RabbitMQ.</p>
    <div class="table-container"><div class="table-contents"><table id="w917aac81d193c55b5"><thead><tr><th class="table-header" colspan="100"><div class="title">Event source parameters that apply to Amazon MQ and RabbitMQ</div></th></tr>
          <tr>
            <th>Parameter</th>
            <th>Required</th>
            <th>Default</th>
            <th>Notes</th>
          </tr>
        </thead>
          <tr>
            <td tabindex="-1">
              <p>BatchSize</p>
            </td>
            <td tabindex="-1">
              <p>N</p>
            </td>
            <td tabindex="-1">
              <p>100</p>
            </td>
            <td tabindex="-1">
              <p>Maximum: 10,000</p>
            </td>
          </tr>
          <tr>
            <td tabindex="-1">
              <p>Enabled</p>
            </td>
            <td tabindex="-1">
              <p>N</p>
            </td>
            <td tabindex="-1">
              <p>true</p>
            </td>
            <td tabindex="-1">
            </td>
          </tr>
          <tr>
            <td tabindex="-1">
              <p>FunctionName</p>
            </td>
            <td tabindex="-1">
              <p>Y</p>
            </td>
            <td tabindex="-1">
            </td>
            <td tabindex="-1">
            </td>
          </tr>
          <tr>
            <td tabindex="-1">
              <p>FilterCriteria</p>
            </td>
            <td tabindex="-1">
              <p>N</p>
            </td>
            <td tabindex="-1">
              <p> </p>
            </td>
            <td tabindex="-1">
              <p><a href="./invocation-eventfiltering.html">Lambda event filtering</a></p>
            </td>
          </tr>
          <tr>
            <td tabindex="-1">
              <p>MaximumBatchingWindowInSeconds</p>
            </td>
            <td tabindex="-1">
              <p>N</p>
            </td>
            <td tabindex="-1">
              <p>500 ms</p>
            </td>
            <td tabindex="-1">
              <p><a href="./invocation-eventsourcemapping.html#invocation-eventsourcemapping-batching">Batching behavior</a></p>
            </td>
          </tr>
          <tr>
            <td tabindex="-1">
              <p>Queues</p>
            </td>
            <td tabindex="-1">
              <p>N</p>
            </td>
            <td tabindex="-1">
            </td>
            <td tabindex="-1">
              <p>The name of the Amazon MQ broker destination queue to consume.</p>
            </td>
          </tr>
          <tr>
            <td tabindex="-1">
              <p>SourceAccessConfigurations</p>
            </td>
            <td tabindex="-1">
              <p>N</p>
            </td>
            <td tabindex="-1">
            </td>
            <td tabindex="-1">
              <p>For ActiveMQ, BASIC_AUTH credentials. For RabbitMQ, can contain both BASIC_AUTH credentials and VIRTUAL_HOST information.</p>
            </td>
          </tr>
        </table></div></div>
  <awsdocs-copyright class="copyright-print"></awsdocs-copyright><awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback></div><noscript><div><div><div><div id="js_error_message"><p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="Warning" /> <strong>Javascript is disabled or is unavailable in your browser.</strong></p><p>To use the Amazon Web Services Documentation, Javascript must be enabled. Please refer to your browser's Help pages for instructions.</p></div></div></div></div></noscript><div id="main-col-footer" class="awsui-util-font-size-0"><div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">Document Conventions</a></div><div class="prev-next"><div id="previous" class="prev-link" accesskey="p" href="./services-lex.html">Lex</div><div id="next" class="next-link" accesskey="n" href="./with-msk.html">MSK</div></div></div><awsdocs-page-utilities></awsdocs-page-utilities></div><div id="quick-feedback-yes" style="display: none;"><div class="title">Did this page help you? - Yes</div><div class="content"><p>Thanks for letting us know we're doing a good job!</p><p>If you've got a moment, please tell us what we did right so we can do more of it.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=Lambda&amp;topic_url=https://docs.aws.amazon.com/en_us/lambda/latest/dg/with-mq.html"></awsui-button></p></div></div><div id="quick-feedback-no" style="display: none;"><div class="title">Did this page help you? - No</div><div class="content"><p>Thanks for letting us know this page needs work. We're sorry we let you down.</p><p>If you've got a moment, please tell us how we can make the documentation better.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=Lambda&amp;topic_url=https://docs.aws.amazon.com/en_us/lambda/latest/dg/with-mq.html"></awsui-button></p></div></div></div></body></div></awsdocs-view><div class="page-loading-indicator" id="page-loading-indicator"><awsui-spinner size="large"></awsui-spinner></div></div><div id="tools-panel" dom-region="tools"><awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel></div></awsui-app-layout><awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner></div></body></html>